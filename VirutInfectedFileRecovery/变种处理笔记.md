搜感染函数的标志: 64 ff 32 64 89 22

body+0x24fa是virus_flag   -11b

在尾节区段, 以e8 ?? (00|??) 00 00搜索初始位置, 基本可以搜到尾节代码入口点.

# 关于变种的代

第一代(旧一代): 头0x1e8, body大小0x3d34,3eb0,3ebc等, 看到的最多, 很多就是改改标记, 有时换一下backvalue2的计算方式sub, add, xor

第二代(半新一代): 头0x2b8, body大小0x4???. 路径重新规划, 加解密代码变化. 

第三代(新一代):头0x300/0x2f8, body大小0x6???  第二代和第三代大体结构相似, 不过还是得重新规划, 加解密代码也变化了.. 另外这一代还可能添加一个垃圾区段(由virus_flag决定)





# 关于不同变种间需要确认的

入口节节尾代码的插入位置, 能否用入口节rsize=vsize来判断存在入口节节尾代码

入口节节尾代码的生成是否一样. 这个比较容易修改, 不像那0x1e8是经过精心构造的.  .. 其实也不容易修改, 要改的话也得对整个代码结构有一定了解. 我估计手上没源码的修改变种只能改改标记. 要大改就只有作者本人才能改.

尾节病毒代码的插入位置, 尾节病毒代码的构成是否仍是由那0x1e8的代码变形而来

病毒的感染标记确认

# 修复时用到的

backvalue2的before_offset位置, backvalue2的藏身指令

c6/c7 05的before_offset位置

头那会变形的0x几百个字节规划跳转路径, 以及最终跳转到body的那个跳转前的有效指令

body的加密方式,body的前几个用于暴破key的字节数值

oep节节尾的那5块中的有效指令, 其中有一块是垃圾指令, 不过不用管是哪一块, 我那个代码已经是通用的.

block_descrip距离body起始偏移数







# 0x20处有标记, 每个标记值意味着一种变种

| 标记值     | 最终段大小 | 说明                                                         |
| ---------- | ---------- | ------------------------------------------------------------ |
| 0x1a6679f7 | 0x3eb0     | 加标记就行                                                   |
| 0x1de86992 |            | 寻找hook点1出错                                              |
| 0x248b5400 | 0x3d34     | 基准代码以这个变种的感染函数写的                             |
| 0x2b284c31 |            | 寻找Hook点1出错                                              |
| 0x3a4b4308 | 0x3eb0     | 加标记就行                                                   |
| 0x4cd54dad | 0x3d34     | 加标记就行                                                   |
| 0x4ce7ef58 |            | 解析入口节节尾病毒代码块出错,需要详细看.  这个oep节尾代码还有点类似, 但是尾节跳转就非常不类似了.. |
| 0x4f551cb8 |            | 这个貌似不是virut                                            |
| 0x5a006a10 | 0x3eb0     | 完成                                                         |
| 0x5bf31a54 | 0x3eb0     | 在源码中改个段大小以及添加标记后就可以处理                   |
| 0x5ae868ff |            | 从oep开始搜索hook点越界                                      |
| 0x5bf31a54 |            | 这个不一样的地方蛮多,得详细看                                |
| 0x5d2e6a5b |            | 这个不一样的地方蛮多,得详细看                                |
| 0x6ce4acce | 0x3eb0     | 加标记就行                                                   |
| 0x6e890200 |            | 找block3位置出错, 得详细看                                   |
| 0x6eb474d8 |            | 找hook点1出错                                                |
| 0x7a9ef856 | 0x3eb0     | 加标记就行                                                   |
| 0x7a1783e3 |            | 找Hook点1位置出错                                            |
| 0x7f870bf0 | 0x3d34     | 加标记就行                                                   |
| 0x8bf6fd6f |            | 找hook点1位置出错                                            |
| 0x10f00e0  |            | 解析尾节跳转代码有问题                                       |
| 0x26dd59b  |            | 找Hook点1位置出错                                            |
| 0x34c07e87 |            | 找hook点1位置出错                                            |
| 0x37eb766c | 0x3d34     | 找hook点1位置出错                                            |
| 0x40d07750 |            | 找Hook点1位置出错                                            |
| 0x90c2b284 | 0x3eb0     | 加个标记就行                                                 |
| 0x97d9f870 | 0x3eb0     | 加个标记就行                                                 |
| 0x268a57ec |            | 找block4位置出错                                             |
| 0x336e6957 |            | 不是virut                                                    |
| 0x341f55a5 |            | 找hook1点1位置出错                                           |
| 0x389ac08  |            | hook点1寻找正确, block3位置寻找出错                          |
| 0x393ab593 | 0x3d34     | 加标记就行                                                   |
| 0x1199ab13 | 0x3ebc     | 加标记, 还得改个段大小 , 另外这个是xor的                     |
| 0x20202020 |            | 解析尾节跳转代码有问题                                       |
| 0x3057831f |            | 找Hook点1位置有问题                                          |
| 0x393e44c  |            | 找hook点1位置有问题                                          |
| 0x480eee90 |            | 找block3位置有问题                                           |
| 0x50746547 |            | 不是virut                                                    |
| 0x55438d4e |            | 加标记就行                                                   |
| 0x714f88ae |            | 找HOOK点1位置出错                                            |
| 0x79249a9c | 0x3ebc     | 加标记,改个段大小                                            |
| 0x800741d1 | 0x3d34     | 加标记就行                                                   |
| 0x812911e9 |            | 找block3位置出错                                             |
| 0x818f00e0 |            | 解析尾节跳转出错                                             |
| 0x8960775a | 0x3d34     | 加标记就行                                                   |
| 0xa0ae5aed | 0x3ebc     | 加标记,改个段大小                                            |
| 0xa5bbb78d |            | 解析尾节跳转有问题                                           |
| 0xaab31668 |            | 找hook点1位置出错                                            |
| 0xac2a4072 |            | 成功                                                         |
| 0x78249a9c |            | BLOCK_DESCRIPT的解密有问题                                   |
| 0xae05593e |            | 寻找hook点1出错                                              |
| 0xb16971f4 | 0x3eb0     | 加标记就行                                                   |
| 0xb45e39c8 | 0x3eb0     | 加标记就行                                                   |
| 0xb5032bb6 | 0x3ebc     | 改区段以及加标记就行, sub                                    |
| 0xbfe10ff8 | 0x3d34     | 加标记就行                                                   |
| 0xc0a81644 | 0x3ebc     | 加标记就行,   sub                                            |
| 0xc2824dac |            | 寻找block3位置出错                                           |
| 0xc2e6c3ea |            | 寻找hook点1位置出错                                          |
| 0xc77d5f14 |            | 寻找hook点1位置出错                                          |
| 0xcec8154  |            | 貌似不是virut变种                                            |
| 0xd1b35b00 | 0x3eb0     | 加标记就行                                                   |
| 0xd21cb95e | 0x3ebc     | 加标记就行,改区段大小                                        |
| 0xd298ab4b | 0x3d34     | 加标记就行                                                   |
| 0xd86ccf72 | 0x3eb0     | 加标记就行                                                   |
| 0xd943a47  |            | 寻找block3位置出错                                           |
| 0xdba10c93 | 0x3ebc     | 加标记,改区段大小                                            |
| 0xdba1f0e  |            | 找Hook点1位置出错                                            |
| 0xded64554 |            | 不是virut                                                    |
| 0xdf7184db |            | 找Hook点1位置出错                                            |
| 0xe4357928 | 0x3eb0     | 加标记                                                       |
| 0xe5e48187 | 0x3d34     | 加标记                                                       |
| 0xeaa9c908 |            | 寻找block3位置出错                                           |
| 0xeb8b6d50 | 0x3eb0     | 加标记                                                       |
| 0xeb8d1f90 | 0x3eb0     | 加标记                                                       |
| 0xeba1f0e  |            | 尾节跳转解析失败                                             |
| 0xee76b100 | 0x3eb0     | 加标记                                                       |
| 0xf610c2e3 | 0x3d34     | 加标记                                                       |
| 0xf63cb5dc | 0x3eb0     | 加标记, oep节尾解析出错                                      |
| 0x7e468610 |            | 找hook点1失败                                                |

## 1de86992

加上了e8都没找到Hook点1..  

0x424样本0x446样本0x58c样本0x5fc 恢复成功

0x58c样本在加减法解密尾节数据出现异常, 发现是多条mov r32, xxx指令导致解密长度赋值错误,已修复

0x6e86样本找block3位置出错.. 发现这个是hook点1位置没搜对.. 靠, 果然给我猜对了, 这个filealignment大小是0x1000.. 然后oep段一共0x2000. 这样就有很大的失误率. 我需要对hook点1跳到Oep节尾的逻辑以及入口点直接修改到oep节尾的逻辑做一些加强. 判断第一块或第二块是否有mov ecx,edx,eax, dd_num b8 b9 ba, dd_virlen,   然后再判断一下这个0x3000<dd_virlen<0x7000, 



这样清除逻辑应该就完整了.  嗯, 我故意在正确的hook点1前加了个假的hook点1, 然后测试成功了..

> 可能为未知变种, 开始尝试处理
> 入口节节尾有病毒代码
> 入口点没被更改,进行hook点1搜索
> HOOK点1跳到了OEP节尾: hook点1 1ee1 入口点节尾2308
> 解析oep节节尾跳转出错
> 可能是hook点1选错,从上次搜到E9的位置后面继续搜索
> HOOK点1跳到了OEP节尾: hook点1 1fc4 入口点节尾2504
> block1中有效指令找到
> 尾节块大小为427c
>  入口节尾病毒使用的寄存器为eax
> OEP节尾病毒使用的加密算法为减法, 密钥为84a3ce0f, 基地址为2d000
> 尾节病毒代码入口点为2d010
> 再次确认block3 index成功
> 用于计算回跳点的值1:42d015
> 用于计算回跳点的值2:fffd4faf
> 尾节最终block块RVA为2d3c1
> 包含那两条恢复指令的病毒代码块RVA为2d1a5
> 在401fc4处恢复四个字节值为300415ff
> 在401fc8处恢复一个字节值为40
> 将尾区段的VSize减小5000 RSize减小5000
> 将PE头的SizeOfImage减小5000 将文件大小减小5000
> 将OEP区段表的VSize减小afc
> 将OEP区段的raddr: 2504处的afc字节清0

又试验了加了N个假跳的:

> 可能为未知变种, 开始尝试处理
> 入口节节尾有病毒代码
> 入口点没被更改,进行hook点1搜索
> HOOK点1跳到了OEP节尾: hook点1 1edd 入口点节尾2166
> 解析oep节节尾跳转出错
> 可能是hook点1选错,从上次搜到E9的位置后面继续搜索
> HOOK点1跳到了OEP节尾: hook点1 1efb 入口点节尾2422
> 解析oep节节尾跳转出错
> 可能是hook点1选错,从上次搜到E9的位置后面继续搜索
> HOOK点1跳到了OEP节尾: hook点1 1f2a 入口点节尾2399
> 解析oep节节尾跳转出错
> 可能是hook点1选错,从上次搜到E9的位置后面继续搜索
> HOOK点1跳到了OEP节尾: hook点1 1fc4 入口点节尾2504
> block1中有效指令找到
> 尾节块大小为427c
>  入口节尾病毒使用的寄存器为eax
> OEP节尾病毒使用的加密算法为减法, 密钥为84a3ce0f, 基地址为2d000
> 尾节病毒代码入口点为2d010
> 再次确认block3 index成功
> 用于计算回跳点的值1:42d015
> 用于计算回跳点的值2:fffd4faf
> 尾节最终block块RVA为2d3c1
> 包含那两条恢复指令的病毒代码块RVA为2d1a5
> 在401fc4处恢复四个字节值为300415ff
> 在401fc8处恢复一个字节值为40
> 将尾区段的VSize减小5000 RSize减小5000
> 将PE头的SizeOfImage减小5000 将文件大小减小5000
> 将OEP区段表的VSize减小afc
> 将OEP区段的raddr: 2504处的afc字节清0



## 2b284c31

加上了e8都没找到Hook点1

经过检查, 发现应该是在被virut感染后又被其他东西感染过的.

另外, 有些样本是被人处理过一次之后的. 所以不用考虑

## 4ce7ef58

可能是virut其他变种, 非常不一样

这个oep节尾代码有效指令也不一样, 尾节代码也不类似.

这个的标志实际上是在timedatestamp(pint->fileheader->timedatestamp)上, 为0x3678a618

这个尾节前部大小为0x300, 估计跟百度那人分析的是同一代的.放着先.

新一代.

## 4f551cb8

0xfb样本, oep节尾病毒代码入口点在45c54c.

基本一样, 只不过这个样本的hook点1/OEP没改.. 没找到跳转到oep节尾的代码..

所以是样本问题, 无视.



## 5a006a10

OEP没问题, 是它文件本身的数据被损坏了.

## 5ae868ff

什么都没搜到,包括最后一个段和倒数第二个段.

最后一个段段名为7个随机小写字母.. 居然还是一个空段

跟4ce7ef58 是同一代的, 入口点在倒数第二个节病毒代码, 最后一个区段应该是病毒构造的.. 放着. 前几天刚说完应该不是virut感染导致的, 今天就被当场打脸...

0x5c7这个就是新一代基准变种, virutkind==2, 只不过被多次感染了, 不用管

## 6e890200

0x20_0x6e890200_0x7ceb 这个入口点不在节尾-filealign的范围内, 入口点也不在尾部区段,  在入口点区段的14541位置, 入口点区段的大小为 vsize 1934b rsize 1854b

入口点就直接是那块尾节跳转解析的代码.

经过调试, 发现尾节跳转代码基本一致.

原OEP 497cb0

发现这个其实是被感染后的文件, 然后可能又感染了其他的病毒, 导致尾部区段又增加了一个. 所以这其实是入口点处于尾部区段的样本.. 所以这个virut变种其实也就添加标记就能搞定的..   另外, 也不必要对其添加什么处理..

0x2c0,0x2c2,0x7ceb都是上面说的这种情况. 可以无视

0x2f1,0x3e7,0x4ed,0x5fb,0x6e修复成功, 这个就没有被其他病毒感染了.



## 6eb474d8

0x20_0x6eb474d8_0x41e  421f6e尾节代码入口点

跟7a1783e3的情况一样,  也是那种没有hook点1, 同时也没有修改OEP的. 是样本问题. 

为了保险起见, 我特意去确认了, 发现的确没有增加尾部区段的代码, 可以确认了.

## 7a1783e3



19b变种的尾节病毒代码入口点在47a368

| 确认点               | 是否一样 | 备注 |
| -------------------- | -------- | ---- |
| vsize==rsize判断     | 一样     |      |
| oep节尾代码一样?     | 一样     |      |
| oep节尾代码插入位置  | 一样     |      |
| 尾节病毒代码一样?    | 一样     |      |
| 尾节病毒代码插入位置 | 一样     |      |
| 标记值               | 修改了   |      |

这个感染标记是40144E80, 所以根本不会找hook点1.  而这个样本又没有改变入口点的值, 所以可以说是样本的问题.  这个样本的入口点应该要在尾节, 却没有. 可能是被修复过的样本, 但没修复完全, 我靠!!     我真是日了狗了..



现在这么看来, 那些找不到hook点1的, 估计都是属于这种情况..  代码甚至都无法触发.  这种情况的出现, 应该就是样本被不完全修复过. 导致这些问题.  这个就算跑起来也跑不到病毒代码.



## 8bf6fd6f

其他很多找不到Hook点1, 但是什么都没搜到.   

0x5bc 0x5f1 0x6cf oep直接在尾节可以修复

0x604,0x82f1, 从hook点1, 到解析Oep节尾, 到解析尾节, 一条龙成功执行后修复.

0xe3 oep节尾block1有效指令解析错误     经过查看发现, 是因为hook点1没找到, 导致从oep开始一直找到oep节尾的block1, 把block1的jmp当做跳转, 这就导致了识别错位了..    而原因,我估计就是这个文件被修复过, 那个修复太垃圾, 就只修复了hook点1的跳转 或者说之修复了oep的值, 然后导致了我这出问题..   所以这个变种, 我是已经完美处理的了..



## 10f00e0

这个也不像virut, 尾部跳转的代码不像, 也可能是差别比较大的变种.

这个非常不像,  尾部代码很花, 如果真是virut, 那么应该是强度较大版本较新的变种.

这个PE头位置比较靠前.

1f6失败,  201成功.. 感觉201是1f6通过fearzip解压后得到的文件..

## 26dd59b

0x9c,0x9e样本, 找HOOK点1位置出错, 不像被感染了, 就一个UPX..  这个应该是被修复过的...

0x198,0x19a, 成功修复

## 34c07e87

0x383样本, 没找到相关病毒代码

0x171样本, hook点1在1001b2d, 而入口点却在1001d0d, 所以导致搜不到Hook点1, 然而, 根据入口点代码

```
01001D0D >/$  44            inc esp
01001D0E  |.  24 04         and al,0x4
01001D10  \.  C3            retn


```

明显, 这个入口点是有问题的. 所以这个样本也是被别人乱搞搞过之后的.  不是我的问题, 可以无视. 也没有必要从入口节节开始处开始搜索.

## 268a57ec

0x3f8样本, 跟26dd59b的0x9c样本很像..    不像virut.. 应该是已经被修复过的了..



## 336e6957



入口点, 跟上面的0x3f8和0x9c样本很像.

0x79样本, 入口点可以看出是virut, 这个样本很特殊, 0x20是336e6957, 0x24是e51c8524, 0x28是0d21796c

00000020  57 69 6E 33 24 85 1C E5 6C 79 21 0D 0A           Win3$?錶y!..

貌似这个是一句话... 然后在0x24位置被病毒插入了标记..  所以其实这个样本应该是0x24为e51c8524的样本.

..按照这样来看, 我就把 最终在blockdescrip结构体中寻找的段大小 判断逻辑修改成大于0x3000然后再加一个beforebytes=afterbytes的判断应该就行了.  另外, 0x20处的标记可能有非常多, 需要对0x20处有标记的, 但不在标记数组中的那些样本进行进一步判断, 不应一步否决.. 那么貌似这个标记判断也就没什么意义了...  还是得去匹配跳转特征.

可以对标记进行一些判断, 例如标记都处于a-zA-Z0-9以及一些特殊符号的情况下, 就可以过滤标记...

另外刚才看了下跳转代码, 这个尾部有0x20变种尾部的相似点, 但又有所区别.



## 1199ab13   (这个变种改了一些的, 得确认..)

body+0x2789是感染函数

0x6c2样本

0x1ca4样本.. 我见鬼了吗??  出现了个奇葩的问题..  后来调试的时候又没出现...

> 1ca4处理日志:      计算回跳点那边有问题.
>
> 可能为未知变种, 开始尝试处理
> 入口节节尾有病毒代码
> 入口点在入口节节尾
> block1中有效指令找到
> 尾节块大小为42f8
>  入口节尾病毒使用的寄存器为eax
> block1中有效指令找到
> OEP节尾病毒使用的加密算法为加法, 密钥为14f12288
> block1中有效指令找到
> block3中有效指令找到
> block4中有效指令找到
> 尾节病毒代码入口点为10108
> 再次确认block3 index成功
> 用于计算回跳点的值1:11010118
> 尾节最终block块RVA为c22f
> 重新设置PE头中的OEP为10118
> 将尾区段的VSize减小6000 RSize减小4400
> 将PE头的SizeOfImage减小6000 将文件大小减小4400
> 将OEP区段表的VSize减小bc
> 将OEP区段的raddr: 5544处的bc字节清0

发现问题在哪儿了, 这里计算backupvalue2时, 使用的是xor, 这就导致了我计算oep出错了.. 然后我错的oep, 再次拿来修复, 就GG了..

```
81 74 24 20 2A 70 01 00 xor dword ptr [esp+20h],1702Ah
```

终于找到为什么不报错了, 因为num_e8call == 2, 然而根本不会==2, 只会== 3, 因为有两个call是连续产生的, ... 所以改成>=就可以了..

经过确认, 只改了那么一个xor.. 其他的都没变..



## 20202020

0x63e样本 找hook点1 出现异常. ... 靠 原来是for里面判断忘记pcode+i了...我晕



0x123, 0x63e, 6db, 6dd, 处理成功, 

0x70d出现有价值的错误信息, 搞定. 跟第三代非常相似的变种.

0x10又是别的一种变种, 搞定了, 这种是0x24处有标记的变种

0x7d2, 是第二代(virutkind==3)的一个变种, 搞定.. 成了virutkind == 9

0x8 virutkind == 0xa, 搞定.



## 3057831f

0x40f2成功修复

0x3af oep节尾病毒入口点在591598, 之前没找到Hook点1, 果然是因为反汇编失败导致的.. 改了之后就可以了

```
... <<前面有N个失败
反汇编指令失败,跳过当前字节
反汇编指令失败,跳过当前字节
反汇编指令失败,跳过当前字节
HOOK点1跳到了OEP节尾: hook点1 8b9ff 入口点节尾191598
block1中有效指令找到
尾节块大小为42c8
 入口节尾病毒使用的寄存器为eax
OEP节尾病毒使用的加密算法为加法, 密钥为e9084945, 基地址为1a8000
尾节病毒代码入口点为1ac157
再次确认block3 index成功
用于计算回跳点的值1:5ac15d
用于计算回跳点的值2:ffedf8a2
尾节最终block块RVA为1a8071
包含那两条恢复指令的病毒代码块RVA为1ac23f
在48b9ff处恢复四个字节值为104015ff
在48ba03处恢复一个字节值为40
将尾区段的VSize减小5000 RSize减小5000
将PE头的SizeOfImage减小5000 将文件大小减小5000
将OEP区段表的VSize减小a68
将OEP区段的raddr: 191598处的a68字节清0
```



## 341f55a5

0x311f成功修复

0x29d, 没有oep节节尾病毒代码, 尾节代码入口在1008dea. 没有Hook点1, 入口点1也没有修改到尾节.. 又是损坏的...



## 389ac08

0x6dd样本, 经过检查, 是因为尾部多了一个区段, 导致的"修改oep到尾节"判断逻辑失败..

是"新一代"的样本, 现在可以确认新一代会添加一个垃圾尾节了..

成功.



## 393ab593

找block1中有效指令失败.. 可能逻辑有什么问题??

发现这个第一块, 他是个垃圾代码块. 后面的有效指令全部顺移下去了, 一共有五块代码, 而不是四块...       //对尾节解析进行了大改, 改完后居然没BUG直接就成功了...

0xa2 0xa4能处理

## 0x393e44c

都是寻找Hook点1出错.

0x222, 尾节病毒代码入口点在0x654200处.  又是没修复好的, 损坏了的样本..

0x3a3, 尾节病毒代码入口点在0x630030,  又是损坏了的样本

## 4ce7ef58

这个只有这一个样本0x581

这个也是有变动.. oep节节尾有效指令不一样..

```
0050FD0D > $  68 1E6A0000   push 0x6A1E
0050FD12   .  F8            clc
0050FD13   .  58            pop eax                      
0050FD14   .^ EB 98         jmp short 0x20_0x4.0050FCAE

0050FCAE   >  FC            cld
0050FCAF   . |66:8190 00E65>adc word ptr ds:[eax+0x5AE600],0x7E9C
0050FCB8   . |41            inc ecx
0050FCB9   . |F6D2          not dl
0050FCBB   . |08E5          or ch,ah
0050FCBD   .^|EB 93         jmp short 0x20_0x4.0050FC52

0050FC52   > /11E2          adc edx,esp
0050FC54   . |8D16          lea edx,dword ptr ds:[esi]
0050FC56   . |FEC9          dec cl
0050FC58   . |83D9 A1       sbb ecx,-0x5F
0050FC5B   . |42            inc edx
0050FC5C   . |83FA EB       cmp edx,-0x15
0050FC5F   . |49            dec ecx
0050FC60   . |83E1 45       and ecx,0x45
0050FC63   . |8D92 246DF1D1 lea edx,dword ptr ds:[edx-0x2E0E92DC]
0050FC69   . |42            inc edx
0050FC6A   . |F6C6 C3       test dh,0xC3
0050FC6D   . |EB 32         jmp short 0x20_0x4.0050FCA1

0050FCA1   > \83E8 02       sub eax,0x2
0050FCA4   .  90            nop
0050FCA5   .  86E9          xchg cl,ch
0050FCA7   .^ EB 86         jmp short 0x20_0x4.0050FC2F

0050FC2F   > /8D1479        lea edx,dword ptr ds:[ecx+edi*2]
0050FC32   . |90            nop
0050FC33   . |8BCE          mov ecx,esi
0050FC35   . |8D8D 584E257B lea ecx,dword ptr ss:[ebp+0x7B254E58]
0050FC3B   . |87D1          xchg ecx,edx
0050FC3D   . |87C9          xchg ecx,ecx
0050FC3F   . |7D 6D         jge short 0x20_0x4.0050FCAE
0050FC41   . |80CE 50       or dh,0x50
0050FC44   . |90            nop
0050FC45   . |BA 92ECAF7D   mov edx,0x7DAFEC92
0050FC4A   .-|E9 85510A00   jmp 0x20_0x4.005B4DD4 跳到尾节



```

这个尾节跳转代码也很不一样...

这个oep节节尾病毒代码还算有点相似.  但尾节解析跳转就非常不一样..

搞定

0x581这个就是新一代基准变种, 只不过被多次感染了, 所以也不用管

## 0x5bf31a54

0x0 在尾节解析出错, 这尾节不像virut的

0x1  block1有效指令找的有问题, 然后在尾节解析出错

0x1a1,0x1aa,0x1b74,0x1d,0x1fc,0x2,0x3,0x7,0x9成功 

0x1a7,0x1a9,0x1ad,0x1af,0x1b,0x1b1,0x1da,0x2d6,0xc,0xe找Hook点1出错, 

0x1aa(2), 0x1ac oep节尾代码解析死循环退出

body+277e是感染函数

1af, 这个hook点1居然跳到了倒数第二个区段, 这才导致没有识别病毒代码..

看了代码, 感染过程一致, 那些不能处理的, 都是因为文件损坏, 或者被其他病毒再次感染后导致的判断逻辑错误.  所以可以无视.

## 5d2e6a5b

这变种的body大小是0x3eb0的

0x37c block1有效指令有问题, 尾节解析有问题.  ..源码中修复了个BUG, 已成功恢复.

0x3a2,0x8b 找hook点1有问题

0x49b,0x4cf ,0x579,0x644修复成功

0x8b样本入口节节尾病毒代码还在, 不过hook点1没找到, 也没更改oep什么的, 而且节尾的block1代码没看到, 只看到了block2, block3, 和block4的代码.  我估计这个应该是被修复坏了的.

## 714f88ae

0x511 找hook点1错误, oep节尾病毒代码在0x47cded, 又是损坏的..  没有hook点1到这儿, 以及oep没有改到这儿..





## 78249a9c

0x410 尾部计算backvalue是用sub方式.



## 0x7a1783e3

全部都是 hook点1搜索失败



## 7e468610

找hook点1失败

这个只有一个样本...

在oep节节尾发现了一些有趣的代码... 这个0x41, 在漏洞利用时很常见

```
005063B0  |> \C745 B8 41414>mov [local.18],0x41414141                          ; |
005063B7  |.  A1 F0625000   mov eax,dword ptr ds:[0x5062F0]                    ; |
005063BC  |.  8D75 B8       lea esi,[local.18]                                 ; |
005063BF  |.  C745 BC 41414>mov [local.17],0x41414141                          ; |
005063C6  |.  C745 C0 41414>mov [local.16],0x41414141                          ; |
005063CD  |.  8945 D8       mov [local.10],eax                                 ; |
005063D0  |.  A1 F4625000   mov eax,dword ptr ds:[0x5062F4]                    ; |
005063D5  |.  C745 C4 41414>mov [local.15],0x41414141                          ; |
005063DC  |.  C745 C8 41414>mov [local.14],0x41414141                          ; |
005063E3  |.  8945 DC       mov [local.9],eax                                  ; |
005063E6  |.  A1 F8625000   mov eax,dword ptr ds:[0x5062F8]                    ; |
005063EB  |.  C745 CC 41414>mov [local.13],0x41414141                          ; |
005063F2  |.  C745 D0 41414>mov [local.12],0x41414141                          ; |
005063F9  |.  8945 E0       mov [local.8],eax                                  ; |
005063FC  |.  A1 FC625000   mov eax,dword ptr ds:[0x5062FC]                    ; |
00506401  |.  C745 D4 41414>mov [local.11],0x41414141                          ; |
00506408  |.  893424        mov dword ptr ss:[esp],esi                         ; |
0050640B  |.  8945 E4       mov [local.7],eax                                  ; |
0050640E  |.  A1 00635000   mov eax,dword ptr ds:[0x506300]                    ; |
00506413  |.  8945 E8       mov [local.6],eax                                  ; |
00506416  |.  A1 04635000   mov eax,dword ptr ds:[0x506304]                    ; |
0050641B  |.  8945 EC       mov [local.5],eax                                  ; |
0050641E  |.  0FB705 086350>movzx eax,word ptr ds:[0x506308]                   ; |
00506425  |.  66:8945 F0    mov word ptr ss:[ebp-0x10],ax                      ; |
00506429  |.  0FB605 0A6350>movzx eax,byte ptr ds:[0x50630A]                   ; |
00506430  |.  8845 F2       mov byte ptr ss:[ebp-0xE],al                       ; |
00506433  |.  E8 D8070000   call <jmp.&KERNEL32.FindAtomA>                     ; \FindAtomA
00506438  |.  0FB7C0        movzx eax,ax
0050643B  |.  83EC 04       sub esp,0x4
0050643E  |.  66:85C0       test ax,ax                                         ; |
00506441  |.  75 5D         jnz short 0x20_0x7.005064A0                        ; |
00506443  |.  C70424 240000>mov dword ptr ss:[esp],0x24                        ; |
0050644A  |.  E8 61050000   call <jmp.&msvcrt.malloc>                          ; \malloc


```

但oep节尾并没有发现virut相关代码.   可能这个不是virut变种, 又或者说这个样本在被virut感染后又被其他东西感染了..

## 812911e9



0x379,  这文件的入口点被改过, 该到了第二个区段, 导致判断逻辑错误. 这个样本没有Oep节尾病毒代码, 最后一个区段有病毒代码, 旧一代的. 另外, 也没找到跳转到最后一个区段的jmp. 这更说明这个样本被其他东西改过了..



## a5bbb78d

> 修复文件0x20_0xa5bbb78d_0x1d3
> 可能为未知变种, 开始尝试处理
> 入口点在最后一个区段
> 找尾节0x3d34的body位置出错

0x1d3, 4227d1, 应该是"新一代"

1d3, 应该是多重感染后, 被修理过的, 不用管.

## 0xaab31668

0x4ca是virut, 没有oep节尾病毒, 有尾节病毒代码

这个应该是第二代, 第二代的变种.  body的加密方式有稍微的不同

这个样本应该是被人修复过, 但是没修复对, 从4deb88这边, 后面被00 截断就可以看出.  这边就一条c6 05, 后面的代码全都不见了..

病毒尾节代码入口点在 4deac6 cmp [esp],-1 

4deb73这个call进去

4d8245是body

不对, 这个应该是第三代的, 尾部有加垃圾区段. body大小0x6628

搞定了.

## ae05593e

0x4c9 0x4cb寻找hook点1出错

  oep节尾病毒位置在4583d8.  不过没有跳过来的..    这文件又是损坏了的. 其他都类似. 所以还是样本问题..

## b16971f4

0x7d oep节尾病毒代码跳转死循环

## b5032bb6

0x4cc 尾节跳转解析错误, 一样, 是sub

## c0a81644

0x84e  尾部跳转解析错误, 感觉段长为3ebc的, 尾部代码可能有些变化..

```
0056EE0A    816C24 20 C4941>sub dword ptr ss:[esp+0x20],0x1694C4

发现了, 这里是用sub的, 改了之后就搞定了
```



## c2824dac

这是"新一代"

这应该是多次感染的样本..  尾部区段很多标志都不正常.

这应该是多次感染的样本, 然后被清除过一次, 导致成了这样. 可以无视.

## d21cb95e

0x752 尾节跳转解析错误, 也是3ebc的.  加了sub就行

## dba1f0e

0x5e57 新一代. virutkind == 4

搞定.

## dba10c93

也是3ebc的, 尾部跳转解析失败

0x2f8, 0x4bb oep节尾跳转解析成功, 跳到尾节后解析失败

0x3a5 入口在尾节, 解析失败

果然, 这个也是sub的.. 所以段长为0x3ebc的, 那个计算backvalue的方法用的是sub..

0x2f8这也是个奇葩样本, filealign也是0x1000, 第一个区段大小也就0x1000, 入口点就在0x10d7, 然后被我代码判断成了入口点在入口节尾, 然后刚好解析正确...     这个文件原来的oep在0x1000.. 就一个c3, 很奇葩... 

## c2e6c3ea

0c4c4 找hook点1出错, 已解决, 也是因为反汇编出错导致的没找到.

0x51e9解析成功

## c77d5f14

找hook点1出错 , 完全没头绪

56401c找到了virut尾节病毒代码跳转

这个应该是第一代, 然而却没有找到Hook点1, oep也不在最后一个区段, 说明这个文件被修复过..   

另外, 虽然rsize==vsize, 但这个oep节节尾却没有病毒代码.  这文件是borland c++ 2002生成的

## d943a47

oep节节尾跳转解析错误

2cb样本,4062e7为hook点1, 跳转到406a85为入口节节尾病毒代码.. 调试这个样本, 发现了我代码的一个逻辑错误.

就是入口点判断在oep节节尾.  当filealign是0x1000时就容易误判, 因为我判断这种情况下入口点就直接在block1的代码, 然后认为此时没有Hook点1.   

现在我的逻辑是, 如果入口在oep节尾但没找到有效指令, 那么就会回去重找hook点1, 同时把hasHook1设为TRUE.. 这样就解决了..



## df7184db

0x163, 找hook点1出错.  也是因为反汇编失败导致没找到的. 已经成功修复

## eaa9c908

0x21d, 0x4c8, 0x505 hook点1搜索出错

新新一代.

## 0xeba1f0e

0x13 入口节 有多条有效加减解密指令, 退出..

0x534, 0x614 寻找hook点1出错

0x54b 无效的区段表头

半新一代的基准样本

0x13还是多条有效解密指令 , 看了下, 发现这个版本之间的push和pop并没有clc.. 所以识别错误..  这个的尾节病毒代码识别也有问题.. 我都不知道0x534是TM的怎么成功的了...  应该分类有问题, 因为这新一代是靠timedatestamp来区分的..

这个样本还有个代码比较有趣

```
push fs
pop gs
push gs:[0x34]    //last error code  代码执行到这儿会崩溃..不知为什么, 然后我就直接把他改成了push fs:[0x34]
pop eax                 
```

在4d105e应该要进去.. 感觉后面两个call就是closehandle滚蛋了..

我错了, 这个应该是半新一代..  因为body的长度为0x486a, 介于0x3d34和0x66e4这两个阶段之间..

0x534成功  , 534不是半新一代变种.. 这个0x20的值不是标记, 可能是其他什么壳之类的存放的暂用数据.

614成功

0x13成功

## f63cb5dc

成功.

## 37eb766c

0xf6样本在找hook点1时碰到了无效指令, 导致中断.   我那边的处理逻辑估计得改一改...  该样本没有Oep节节尾病毒代码, 病毒代码在尾节的0x444280处. 所以这样样本, 要么就是hook点1跳到末尾, 要么就是oep修改到末尾.. 结合这个样本的尾节代码, 可以看出基本是同一类的. 所以这个样本也是被人修复过, 但没修复对..

也是0x3d34

## 40d07750

在1df中,果然是因为找Hook点1的时候反汇编失败而导致没找到hook点1的, 添加了跳过逻辑后, 就找到了..

```
入口节节尾有病毒代码
入口点没被更改,进行hook点1搜索
反汇编指令失败,跳过当前字节
反汇编指令失败,跳过当前字节
反汇编指令失败,跳过当前字节
反汇编指令失败,跳过当前字节
反汇编指令失败,跳过当前字节
反汇编指令失败,跳过当前字节
反汇编指令失败,跳过当前字节
反汇编指令失败,跳过当前字节
反汇编指令失败,跳过当前字节
反汇编指令失败,跳过当前字节
HOOK点1跳到了OEP节尾: hook点1 d7c2 入口点节尾10110
block1中有效指令找到
尾节块大小为4164
 入口节尾病毒使用的寄存器为eax
OEP节尾病毒使用的加密算法为加法, 密钥为794f5a5f, 基地址为5ee00
尾节病毒代码入口点为62eec
再次确认block3 index成功
用于计算回跳点的值1:462ef1
用于计算回跳点的值2:fffaa8d1
尾节最终block块RVA为5ee15
包含那两条恢复指令的病毒代码块RVA为62b79
在40d7c2处恢复四个字节值为27bde8
在40d7c6处恢复一个字节值为0
将尾区段的VSize减小5000 RSize减小4200
将PE头的SizeOfImage减小5000 将文件大小减小4200
将OEP区段表的VSize减小16c
将OEP区段的raddr: f494处的16c字节清0
```

0x10也能处理了

## 480eee90

0x375 这个也是新一代..  另外这比较变态, 尾巴多了很多个垃圾区段. 入口点在最后一个有效区段.

多次感染

这TM的真是一个牛逼的变种, 一层又一层一层又一层, 给我提供了许多变种..

第一层是第5代, 第二层是第1代, 第三层是第6代

搞定了

## 818f00e0

新一代, 不过这个区段后面没看到 垃圾区段.  因为垃圾区段可有可无 ..

1eb成功.



## cec8154

不是virut.