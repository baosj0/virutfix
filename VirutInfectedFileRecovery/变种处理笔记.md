body+0x2615可以找到感染函数

body+0x24fa是virus_flag   -11b

在尾节区段, 以e8 ?? 00 00 00搜索初始位置, 基本可以搜到尾节代码入口点.

# 关于不同变种间需要确认的

入口节节尾代码的插入位置, 能否用入口节rsize=vsize来判断存在入口节节尾代码

入口节节尾代码的生成是否一样. 这个比较容易修改, 不像那0x1e8是经过精心构造的.  .. 其实也不容易修改, 要改的话也得对整个代码结构有一定了解. 我估计手上没源码的修改变种只能改改标记. 要大改就只有作者本人才能改.

尾节病毒代码的插入位置, 尾节病毒代码的构成是否仍是由那0x1e8的代码变形而来

病毒的感染标记确认



# 0x20处有标记, 每个标记值意味着一种变种

| 标记值     | 最终段大小 | 说明                                                         |
| ---------- | ---------- | ------------------------------------------------------------ |
| 0x1a6679f7 | 0x3eb0     | 加标记就行                                                   |
| 0x1de86992 |            | 寻找hook点1出错                                              |
| 0x248b5400 | 0x3d34     | 基准代码以这个变种的感染函数写的                             |
| 0x2b284c31 |            | 寻找Hook点1出错                                              |
| 0x3a4b4308 | 0x3eb0     | 加标记就行                                                   |
| 0x4cd54dad | 0x3d34     | 加标记就行                                                   |
| 0x4ce7ef58 |            | 解析入口节节尾病毒代码块出错,需要详细看.  这个oep节尾代码还有点类似, 但是尾节跳转就非常不类似了.. |
| 0x4f551cb8 |            | 这个貌似不是virut                                            |
| 0x5a006a10 | 0x3eb0     | 完成                                                         |
| 0x5bf31a54 | 0x3eb0     | 在源码中改个段大小以及添加标记后就可以处理                   |
| 0x5ae868ff |            | 从oep开始搜索hook点越界                                      |
| 0x5bf31a54 |            | 这个不一样的地方蛮多,得详细看                                |
| 0x5d2e6a5b |            | 这个不一样的地方蛮多,得详细看                                |
| 0x6ce4acce | 0x3eb0     | 加标记就行                                                   |
| 0x6e890200 |            | 找block3位置出错, 得详细看                                   |
| 0x6eb474d8 |            | 找hook点1出错                                                |
| 0x7a9ef856 | 0x3eb0     | 加标记就行                                                   |
| 0x7a1783e3 |            | 找Hook点1位置出错                                            |
| 0x7f870bf0 | 0x3d34     | 加标记就行                                                   |
| 0x8bf6fd6f |            | 找hook点1位置出错                                            |
| 0x10f00e0  |            | 解析尾节跳转代码有问题                                       |
| 0x26dd59b  |            | 找Hook点1位置出错                                            |
| 0x34c07e87 |            | 找hook点1位置出错                                            |
| 0x37eb766c |            | 找hook点1位置出错                                            |
| 0x40d07750 |            | 找Hook点1位置出错                                            |
| 0x90c2b284 | 0x3eb0     | 加个标记就行                                                 |
| 0x97d9f870 | 0x3eb0     | 加个标记就行                                                 |
| 0x268a57ec |            | 找block4位置出错                                             |
| 0x336e6957 |            | 不是virut                                                    |
| 0x341f55a5 |            | 找hook1点1位置出错                                           |
| 0x389ac08  |            | hook点1寻找正确, block3位置寻找出错                          |
| 0x393ab593 | 0x3d34     | 加标记就行                                                   |
| 0x1199ab13 | 0x3ebc     | 加标记, 还得改个段大小 , 另外这个是xor的                     |
| 0x20202020 |            | 解析尾节跳转代码有问题                                       |
| 0x3057831f |            | 找Hook点1位置有问题                                          |
| 0x393e44c  |            | 找hook点1位置有问题                                          |
| 0x480eee90 |            | 找block3位置有问题                                           |
| 0x50746547 |            | 不是virut                                                    |
| 0x55438d4e |            | 加标记就行                                                   |
| 0x714f88ae |            | 找HOOK点1位置出错                                            |
| 0x79249a9c | 0x3ebc     | 加标记,改个段大小                                            |
| 0x800741d1 | 0x3d34     | 加标记就行                                                   |
| 0x812911e9 |            | 找block3位置出错                                             |
| 0x818f00e0 |            | 解析尾节跳转出错                                             |
| 0x8960775a | 0x3d34     | 加标记就行                                                   |
| 0xa0ae5aed | 0x3ebc     | 加标记,改个段大小                                            |
| 0xa5bbb78d |            | 解析尾节跳转有问题                                           |
| 0xaab31668 |            | 找hook点1位置出错                                            |
| 0xac2a4072 |            | 成功                                                         |
| 0x78249a9c |            | BLOCK_DESCRIPT的解密有问题                                   |
| 0xae05593e |            | 寻找hook点1出错                                              |
| 0xb16971f4 | 0x3eb0     | 加标记就行                                                   |
| 0xb45e39c8 | 0x3eb0     | 加标记就行                                                   |
| 0xb5032bb6 | 0x3ebc     | 改区段以及加标记就行                                         |
| 0xbfe10ff8 | 0x3d34     | 加标记就行                                                   |
| 0xc0a81644 | 0x3ebc     | 加标记就行                                                   |
| 0xc2824dac |            | 寻找block3位置出错                                           |
| 0xc2e6c3ea |            | 寻找hook点1位置出错                                          |
| 0xc77d5f14 |            | 寻找hook点1位置出错                                          |
| 0xcec8154  |            | 貌似不是virut变种                                            |
| 0xd1b35b00 | 0x3eb0     | 加标记就行                                                   |
| 0xd21cb95e | 0x3ebc     | 加标记就行,改区段大小                                        |
| 0xd298ab4b | 0x3d34     | 加标记就行                                                   |
| 0xd86ccf72 | 0x3eb0     | 加标记就行                                                   |
| 0xd943a47  |            | 寻找block3位置出错                                           |
| 0xdba10c93 | 0x3ebc     | 加标记,改区段大小                                            |
| 0xdba1f0e  |            | 找Hook点1位置出错                                            |
| 0xded64554 |            | 没日志,暂不清                                                |
| 0xdf7184db |            | 找Hook点1位置出错                                            |
| 0xe4357928 | 0x3eb0     | 加标记                                                       |
| 0xe5e48187 | 0x3d34     | 加标记                                                       |
| 0xeaa9c908 |            | 寻找block3位置出错                                           |
| 0xeb8b6d50 | 0x3eb0     | 加标记                                                       |
| 0xeb8d1f90 | 0x3eb0     | 加标记                                                       |
| 0xeba1f0e  |            | 尾节跳转解析失败                                             |
| 0xee76b100 | 0x3eb0     | 加标记                                                       |
| 0xf610c2e3 | 0x3d34     | 加标记                                                       |
| 0xf63cb5dc | 0x3eb0     | 加标记, oep节尾解析出错                                      |
| 0x7e468610 |            | 找hook点1失败                                                |

## 1de86992

加上了e8都没找到Hook点1

0x424样本0x446样本0x58c样本0x5fc 恢复成功

0x58c样本在加减法解密尾节数据出现异常, 发现是多条mov r32, xxx指令导致解密长度赋值错误,已修复

0x6e86样本找block3位置出错.. 发现这个是hook点1位置没搜对.. 靠, 果然给我猜对了, 这个filealignment大小是0x1000.. 然后oep段一共0x2000. 这样就有很大的失误率









## 2b284c31

加上了e8都没找到Hook点1

## 4ce7ef58

可能是virut其他变种, 非常不一样

## 4f551cb8

不像virut, 差别很大

## 5a006a10

OEP没问题, 是它文件本身的数据被损坏了.

## 5ae868ff

什么都没搜到,包括最后一个段和倒数第二个段.

最后一个段段名为7个随机小写字母.. 居然还是一个空段

## 6e890200

0x20_0x6e890200_0x7ceb 这个入口点不在节尾-filealign的范围内, 入口点也不在尾部区段,  在入口点区段的14541位置, 入口点区段的大小为 vsize 1934b rsize 1854b

入口点就直接是那块尾节跳转解析的代码.

经过调试, 发现尾节跳转代码基本一致.

原OEP 497cb0

发现这个其实是被感染后的文件, 然后可能又感染了其他的病毒, 导致尾部区段又增加了一个. 所以这其实是入口点处于尾部区段的样本.. 所以这个virut变种其实也就添加标记就能搞定的..   另外, 也不必要对其添加什么处理..

0x2c0,0x2c2都是上面说的这种情况.

0x2f1,0x3e7,0x4ed,0x5fb,0x6e修复成功, 这个就没有被其他病毒感染了.

0x7ceb 找hook点1位置出错





## 6eb474d8

0x20_0x6eb474d8_0x41e  421f6e尾节代码入口点

跟7a1783e3的情况一样,  也是那种没有hook点1, 同时也没有修改OEP的. 是样本问题. 



## 7a1783e3



19b变种的尾节病毒代码入口点在47a368

| 确认点               | 是否一样 | 备注 |
| -------------------- | -------- | ---- |
| vsize==rsize判断     | 一样     |      |
| oep节尾代码一样?     | 一样     |      |
| oep节尾代码插入位置  | 一样     |      |
| 尾节病毒代码一样?    | 一样     |      |
| 尾节病毒代码插入位置 | 一样     |      |
| 标记值               | 修改了   |      |

这个感染标记是40144E80, 所以根本不会找hook点1.  而这个样本又没有改变入口点的值, 所以可以说是样本的问题.  这个样本的入口点应该要在尾节, 却没有. 可能是被修复过的样本, 但没修复完全, 我靠!!     我真是日了狗了..



现在这么看来, 那些找不到hook点1的, 估计都是属于这种情况..  代码甚至都无法触发.  这种情况的出现, 应该就是样本被不完全修复过. 导致这些问题.  这个就算跑起来也跑不到病毒代码.



## 8bf6fd6f

其他很多找不到Hook点1, 但是什么都没搜到.   可能是相差比较大的变种

0x5bc 0x5f1 0x6cf oep直接在尾节可以修复

0x604,0x82f1, 从hook点1, 到解析Oep节尾, 到解析尾节, 一条龙成功执行后修复.

0xe3 oep节尾block1有效指令解析错误



## 10f00e0

这个也不像virut, 尾部跳转的代码不像, 也可能是差别比较大的变种.



## 26dd59b

0x9c,0x9e样本, 找HOOK点1位置出错, 不像被感染了, 就一个UPX..

0x198,0x19a, 成功修复

## 34c07e87

0x383样本, 没找到相关病毒代码

//暂时不处理HOOK点1找不到的了, 这个感觉都是误报以及文件损坏等问题..

## 268a57ec

0x3f8样本, 跟26dd59b的0x9c样本很像..    不像virut



## 336e6957



入口点, 跟上面的0x3f8和0x9c样本很像.

0x79样本, 入口点可以看出是virut, 这个样本很特殊, 0x20是336e6957, 0x24是e51c8524, 0x28是0d21796c

00000020  57 69 6E 33 24 85 1C E5 6C 79 21 0D 0A           Win3$?錶y!..

貌似这个是一句话... 然后在0x24位置被病毒插入了标记..  所以其实这个样本应该是0x24为e51c8524的样本.

..按照这样来看, 我就把 最终在blockdescrip结构体中寻找的段大小 判断逻辑修改成大于0x3000然后再加一个beforebytes=afterbytes的判断应该就行了.  另外, 0x20处的标记可能有非常多, 需要对0x20处有标记的, 但不在标记数组中的那些样本进行进一步判断, 不应一步否决.. 那么貌似这个标记判断也就没什么意义了...  还是得去匹配跳转特征.

可以对标记进行一些判断, 例如标记都处于a-zA-Z0-9以及一些特殊符号的情况下, 就可以过滤标记...

另外刚才看了下跳转代码, 这个尾部有0x20变种尾部的相似点, 但又有所区别.



## 1199ab13   (这个变种改了一些的, 得确认..)

body+0x2789是感染函数

0x6c2样本

0x1ca4样本.. 我见鬼了吗??  出现了个奇葩的问题..  后来调试的时候又没出现...

> 1ca4处理日志:      计算回跳点那边有问题.
>
> 可能为未知变种, 开始尝试处理
> 入口节节尾有病毒代码
> 入口点在入口节节尾
> block1中有效指令找到
> 尾节块大小为42f8
>  入口节尾病毒使用的寄存器为eax
> block1中有效指令找到
> OEP节尾病毒使用的加密算法为加法, 密钥为14f12288
> block1中有效指令找到
> block3中有效指令找到
> block4中有效指令找到
> 尾节病毒代码入口点为10108
> 再次确认block3 index成功
> 用于计算回跳点的值1:11010118
> 尾节最终block块RVA为c22f
> 重新设置PE头中的OEP为10118
> 将尾区段的VSize减小6000 RSize减小4400
> 将PE头的SizeOfImage减小6000 将文件大小减小4400
> 将OEP区段表的VSize减小bc
> 将OEP区段的raddr: 5544处的bc字节清0

发现问题在哪儿了, 这里计算backupvalue2时, 使用的是xor, 这就导致了我计算oep出错了.. 然后我错的oep, 再次拿来修复, 就GG了..

```
81 74 24 20 2A 70 01 00 xor dword ptr [esp+20h],1702Ah
```

终于找到为什么不报错了, 因为num_e8call == 2, 然而根本不会==2, 只会== 3, 因为有两个call是连续产生的, ... 所以改成>=就可以了..

经过确认, 只改了那么一个xor.. 其他的都没变..



## 20202020

0x63e样本 找hook点1 出现异常. ... 靠 原来是for里面判断忘记pcode+i了...我晕



## 3057831f

0x40f2成功修复



## 341f55a5

0x311f成功修复



## 389ac08

0x6dd样本, 经过检查, 是因为尾部多了一个区段, 导致的"修改oep到尾节"判断逻辑失败..



## 393ab593

找block1中有效指令失败.. 可能逻辑有什么问题??

发现这个第一块, 他是个垃圾代码块. 后面的有效指令全部顺移下去了, 一共有五块代码, 而不是四块...       //对尾节解析进行了大改, 改完后居然没BUG直接就成功了...

0xa2 0xa4能处理

## 0x393e44c

都是寻找Hook点1出错.

## 4ce7ef58

这个只有这一个样本0x581

这个也是有变动.. oep节节尾有效指令不一样..

```
0050FD0D > $  68 1E6A0000   push 0x6A1E
0050FD12   .  F8            clc
0050FD13   .  58            pop eax                      
0050FD14   .^ EB 98         jmp short 0x20_0x4.0050FCAE

0050FCAE   >  FC            cld
0050FCAF   . |66:8190 00E65>adc word ptr ds:[eax+0x5AE600],0x7E9C
0050FCB8   . |41            inc ecx
0050FCB9   . |F6D2          not dl
0050FCBB   . |08E5          or ch,ah
0050FCBD   .^|EB 93         jmp short 0x20_0x4.0050FC52

0050FC52   > /11E2          adc edx,esp
0050FC54   . |8D16          lea edx,dword ptr ds:[esi]
0050FC56   . |FEC9          dec cl
0050FC58   . |83D9 A1       sbb ecx,-0x5F
0050FC5B   . |42            inc edx
0050FC5C   . |83FA EB       cmp edx,-0x15
0050FC5F   . |49            dec ecx
0050FC60   . |83E1 45       and ecx,0x45
0050FC63   . |8D92 246DF1D1 lea edx,dword ptr ds:[edx-0x2E0E92DC]
0050FC69   . |42            inc edx
0050FC6A   . |F6C6 C3       test dh,0xC3
0050FC6D   . |EB 32         jmp short 0x20_0x4.0050FCA1

0050FCA1   > \83E8 02       sub eax,0x2
0050FCA4   .  90            nop
0050FCA5   .  86E9          xchg cl,ch
0050FCA7   .^ EB 86         jmp short 0x20_0x4.0050FC2F

0050FC2F   > /8D1479        lea edx,dword ptr ds:[ecx+edi*2]
0050FC32   . |90            nop
0050FC33   . |8BCE          mov ecx,esi
0050FC35   . |8D8D 584E257B lea ecx,dword ptr ss:[ebp+0x7B254E58]
0050FC3B   . |87D1          xchg ecx,edx
0050FC3D   . |87C9          xchg ecx,ecx
0050FC3F   . |7D 6D         jge short 0x20_0x4.0050FCAE
0050FC41   . |80CE 50       or dh,0x50
0050FC44   . |90            nop
0050FC45   . |BA 92ECAF7D   mov edx,0x7DAFEC92
0050FC4A   .-|E9 85510A00   jmp 0x20_0x4.005B4DD4 跳到尾节



```

这个尾节跳转代码也很不一样...

这个oep节节尾病毒代码还算有点相似.  但尾节解析跳转就非常不一样..

## 0x5bf31a54

0x0 在尾节解析出错

0x1  block1有效指令找的有问题, 然后在尾节解析出错

0x1a1,0x1aa,0x1b74,0x1d,0x1fc,0x2,0x3,0x7,0x9成功 

0x1a7,0x1a9,0x1ad,0x1af,0x1b,0x1b1,0x1da,0x2d6,0xc,0xe找Hook点1出错, 

0x1aa(2), 0x1ac oep节尾代码解析死循环退出



## 5d2e6a5b

0x37c block1有效指令有问题, 尾节解析有问题.

0x3a2,0x8b 找hook点1有问题

0x49b,0x4cf ,0x579,0x644修复成功



## 714f88ae

0x511 找hook点1错误



## 78249a9c

0x410尾部跳转解析有问题



## 0x7a1783e3

全部都是 hook点1搜索失败



## 7e468610

找hook点1失败



## 812911e9

0x1eb  oep节节尾代码解析错误



## 812911e9

0x37f 尾节解析错误



## a5bbb78d

> 修复文件0x20_0xa5bbb78d_0x1d3
> 可能为未知变种, 开始尝试处理
> 入口点在最后一个区段
> 找尾节0x3d34的body位置出错

## 0xaab31668

找Hook点1出错

## ae05593e

0x4c9 0x4cb寻找hook点1出错

## b16971f4

0x7d oep节尾病毒代码跳转死循环

## b5032bb6

0x4cc 尾节跳转解析错误

## c0a81644

0x84e  尾部跳转解析错误, 感觉段长为3ebc的, 尾部代码可能有些变化..

## c2824dac

oep节节尾解析错误

## d21cb95e

0x752 尾节跳转解析错误, 也是3ebc的

## dba10c93

也是3ebc的, 尾部跳转解析失败

0x5e57 寻找hook点1失败

0x2f8, 0x4bb oep节尾跳转解析成功, 跳到尾节后解析失败

0x3a5 入口在尾节, 解析失败

## c2e6c3ea

0c4c4 找hook点1出错

0x51e9解析成功

## c77d5f14

找hook点1出错



## d943a47

oep节节尾跳转解析错误



## df7184db

0x163, 找hook点1出错

## eaa9c908

0x21d, 0x4c8, 0x505 hook点1搜索出错

## 0xeba1f0e

0x13 入口节 有多条有效加减解密指令, 退出..

0x534, 0x614 寻找hook点1出错

0x54b 无效的区段表头

## f63cb5dc

0x3cf   oep节节尾block1解析出错

